#!/bin/sh
source $HOME/.venv/gpu/bin/activate

if [ $# == 0 ]; then
    files=("$(find . -iname '*MMStack_Pos0.ome.tif' | head -n 1)")
else
    files=("$@")
fi

for file in "${files[@]}"
do
    if [[ "$file" =~ '.ome.tif' ]]; then
        stem="$(echo ${file} | sed 's/\.ome\.tif$//')"
    elif [[ "$file" =~ '.tif' ]]; then
        stem="$(echo ${file} | sed 's/\.tif$//')"
    else
        echo "Not an image file: ${file}"
        continue
    fi
	output_crop="${stem}_crop_0.tif"
	output_fusion_0="${stem}_fusion_0.tif"
	output_fusion_1="${stem}_fusion_1.tif"
    mmcrop.py -P 0 "$file"

	# Main = A, Sub = B
	echo "Output ${output_fusion_0} for Path A"
	mmfusion.py -g 0 -m 0 -s 1 -r -90 -e Full -o "$output_fusion_0" "$output_crop"

	# Main = B, Sub = A
	echo "Output ${output_fusion_1} for Path B"
	mmfusion.py -g 0 -m 0 -s 1 -r 90 -e Full -o "$output_fusion_1" "$output_crop"


	# This worked for the sub channel acquired using Path B
	#mmfusion.py -g 0 -m 1 -s 0 -r -90 -e Full -o "$output_fusion_1" "$output_crop"
done

